<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Bus Routes (Mappls)</title>
    <style>
      #map {
        width: 100%;
        height: 100vh;
      }
      .popup {
        font-size: 13px;
        line-height: 1.4;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      const MMI_KEY = "79627e72edb6a97491f39bf6f2ff0292"; // replace with your key
      const TRIPS_API = "http://localhost:5555/api/admin/livetrips"; // your backend

      async function fetchTrips() {
        const res = await fetch(TRIPS_API);
        const data = await res.json();
        return data.trips || [];
      }

      async function getRoutePath(stops) {
        // Convert stops to "lng,lat" format
        const coords = stops.map((s) => `${s.lng},${s.lat}`).join(";");

        const url = `https://apis.mapmyindia.com/advancedmaps/v1/${MMI_KEY}/route_adv/driving/${coords}?geometries=geojson&overview=full`;

        const response = await fetch(url);
        const data = await response.json();

        if (!data.routes || !data.routes[0]) return null;

        return data.routes[0].geometry.coordinates.map(([lng, lat]) => ({
          lat,
          lng,
        }));
      }

      async function initMap() {
        const map = new mappls.Map("map", {
          center: [16.68, 74.23],
          zoom: 12,
        });

        const trips = await fetchTrips();
        if (!trips.length) {
          alert("No trips found!");
          return;
        }

        const colors = ["#007bff", "#28a745", "#ff5733", "#ffcc00", "#a020f0"];

        for (const [index, trip] of trips.entries()) {
          const color = colors[index % colors.length];

          // 1Ô∏è‚É£ Get road-following path using MMI route API
          const roadPath = await getRoutePath(trip.stops);
          if (!roadPath) continue;

          // 2Ô∏è‚É£ Draw the polyline
          new mappls.Polyline({
            map,
            path: roadPath,
            strokeColor: color,
            strokeOpacity: 0.9,
            strokeWeight: 5,
          });

          // 3Ô∏è‚É£ Add stop markers
          trip.stops.forEach((stop, i) => {
            const marker = new mappls.marker({
              map,
              position: { lat: parseFloat(stop.lat), lng: parseFloat(stop.lng) },
              popupHtml: `
                <div class="popup">
                  <b>${stop.name}</b><br>
                  Stop Order: ${stop.order}<br>
                  Distance from previous: ${stop.distance_from_prev_km} km
                </div>
              `,
              icon: {
                url:
                  i === 0
                    ? "https://cdn-icons-png.flaticon.com/512/684/684908.png"
                    : i === trip.stops.length - 1
                    ? "https://cdn-icons-png.flaticon.com/512/684/684908.png"
                    : "https://cdn-icons-png.flaticon.com/512/2529/2529521.png",
                width: 30,
                height: 30,
              },
            });
          });

          // 4Ô∏è‚É£ Optional route label marker
          const midIndex = Math.floor(trip.stops.length / 2);
          new mappls.marker({
            map,
            position: {
              lat: parseFloat(trip.stops[midIndex].lat),
              lng: parseFloat(trip.stops[midIndex].lng),
            },
            popupHtml: `
              <div class="popup">
                üöå <b>${trip.route_name}</b><br>
                Driver: ${trip.driver_name}<br>
                Bus: ${trip.bus_number}<br>
                Shift: ${trip.shift}
              </div>
            `,
          });
        }
      }
    </script>

    <script
      src="https://apis.mappls.com/advancedmaps/api/79627e72edb6a97491f39bf6f2ff0292/map_sdk?layer=vector&v=3.0&callback=initMap"
      defer
      async
    ></script>
  </body>
</html>
