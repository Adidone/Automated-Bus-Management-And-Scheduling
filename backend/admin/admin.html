<!DOCTYPE html>
<html>
<head>
    <title>Admin Live Bus Tracking</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        #map {
            width: 100%;
            height: 90vh;
        }
    </style>
</head>

<body>
    <h2 style="text-align:center;">ğŸš Admin Live Bus Tracking</h2>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // âœ… Stops (Route Stops)
        const stops = [
            [16.57616197, 74.29479831],
            [16.58377964, 74.30980429],
            [16.62039870, 74.29770568],
            [16.63783643, 74.27932786],
            [16.65451617, 74.26181243]
        ];

        // âœ… Initialize Map
        const map = L.map('map').setView(stops[0], 12);

        // âœ… Tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        // âœ… Display Stop Markers
        stops.forEach((stop, i) => {
            L.marker(stop).addTo(map).bindPopup("Stop " + (i + 1));
        });

        // âœ… ORS API Key
        const apiKey = "5b3ce3597851110001cf6248060d2fdd37ed411cba69c80b4ab04135";

        // âœ… Draw Real Road Route
        fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson", {
            method: "POST",
            headers: {
                "Authorization": apiKey,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                coordinates: stops.map(s => [s[1], s[0]])
            })
        })
        .then(res => res.json())
        .then(data => {
            const routeCoords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
            L.polyline(routeCoords, { color: "blue", weight: 5 }).addTo(map);
        });

        // âœ… Live Bus Marker
        let busMarker = null;
        const driverId = 3;

        function fetchDriverLocation() {
            fetch(`https://10.222.218.121:5555/driver/live-location?driver_id=${driverId}`)
                .then(res => res.json())
                .then(data => {
                    const { latitude, longitude } = data;
                    if (!latitude || !longitude) return;

                    const position = [latitude, longitude];

                    // âœ… Create marker first time
                    if (!busMarker) {
                        busMarker = L.marker(position, { 
                            icon: L.icon({
                                iconUrl: "https://cdn-icons-png.flaticon.com/512/61/61231.png",
                                iconSize: [40, 40]
                            })
                        }).addTo(map).bindPopup("ğŸš Live Bus");
                    } else {
                        // âœ… Update marker position
                        busMarker.setLatLng(position);
                    }

                    // âœ… Auto-follow bus
                    map.panTo(position);

                })
                .catch(err => console.log(err));
        }

        // âœ… Fetch every 2 seconds
        setInterval(fetchDriverLocation, 2000);

    </script>
</body>
</html>
